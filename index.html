<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Clone - Super Web App</title>
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Whitney', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
            background: #36393f;
            color: #dcddde;
            overflow: hidden;
            font-size: 16px;
            line-height: 1.4;
        }

        a {
            color: #00aff4;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Authentication UI */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s ease;
        }

        #auth-box {
            background: #2f3136;
            padding: 40px;
            border-radius: 8px;
            width: 480px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
        }

        #auth-box h2 {
            color: #fff;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        #auth-box input {
            width: 100%;
            padding: 12px;
            margin: 12px 0;
            border: 1px solid #202225;
            border-radius: 4px;
            background: #40444b;
            color: #fff;
            font-size: 16px;
            transition: border-color 0.2s ease, background 0.2s ease;
        }

        #auth-box input:focus {
            border-color: #5865f2;
            background: #4f545c;
            outline: none;
        }

        #auth-box button {
            width: 100%;
            padding: 14px;
            margin: 10px 0;
            border: none;
            border-radius: 4px;
            background: #5865f2;
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        #auth-box button:hover {
            background: #4752c4;
            transform: translateY(-2px);
        }

        #auth-box #logout-btn {
            background: #ed4245;
            display: none;
        }

        #auth-box #logout-btn:hover {
            background: #c42b2e;
        }

        #auth-error {
            color: #ed4245;
            font-size: 14px;
            margin-top: 12px;
        }

        /* Main App UI */
        #app {
            display: none;
            flex: 1;
            background: #36393f;
        }

        .sidebar {
            width: 72px;
            background: #202225;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            overflow-y: auto;
            border-right: 1px solid #1a1c20;
            transition: width 0.3s ease;
            overflow-x: hidden;
        }

        .sidebar:hover {
            width: 80px;
        }

        .server-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin: 8px 0;
            cursor: pointer;
            transition: border-radius 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }

        .server-icon:hover {
            border-radius: 16px;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .server-icon.active::after {
            content: '';
            position: absolute;
            left: -12px;
            top: 50%;
            width: 8px;
            height: 20px;
            background: #fff;
            border-radius: 0 4px 4px 0;
            transform: translateY(-50%);
            transition: height 0.2s ease;
        }

        .server-icon.active:hover::after {
            height: 40px;
        }

        .server-create {
            width: 48px;
            height: 48px;
            background: #3ba55d;
            border-radius: 50%;
            color: #fff;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
        }

        .server-create:hover {
            background: #2d7d46;
            transform: scale(1.1);
        }

        .server-tooltip {
            position: absolute;
            left: 90px;
            background: #18191c;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            color: #fff;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .server-icon:hover .server-tooltip {
            opacity: 1;
        }

        /* Channels Panel */
        .channels {
            width: 240px;
            background: #2f3136;
            padding: 12px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #202225;
            transition: width 0.3s ease;
        }
        
        .channels h3 {
            color: #8e9297;
            font-size: 16px;
            text-transform: uppercase;
            margin: 16px 0 8px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .channels h4 {
            color: #8e9297;
            font-size: 12px;
            text-transform: uppercase;
            margin: 16px 0 8px;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .channels h4 span.title {
            flex: 1;
        }

        .channels h4 button, .channels h3 button {
            background: none;
            border: none;
            color: #b9bbbe;
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s ease;
        }

        .channels h4 button:hover, .channels h3 button:hover {
            color: #fff;
        }

        .channel {
            padding: 8px 10px;
            color: #8e9297;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border-radius: 4px;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .channel:hover,
        .channel.active {
            background: rgba(79, 84, 92, 0.3);
            color: #fff;
        }

        .channel svg {
            margin-right: 8px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .channel:hover svg,
        .channel.active svg {
            opacity: 1;
        }

        .channel-members {
            flex: 1;
            overflow-y: auto;
        }

        .member {
            padding: 6px 10px;
            font-size: 14px;
            color: #b9bbbe;
            display: flex;
            align-items: center;
            transition: background 0.2s ease;
        }

        .member:hover {
            background: rgba(79, 84, 92, 0.2);
        }

        .member.online::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #3ba55d;
            border-radius: 50%;
            margin-right: 8px;
        }

        .search-bar {
            width: 100%;
            padding: 8px 12px;
            margin: 10px 0;
            border: 1px solid #202225;
            border-radius: 4px;
            background: #40444b;
            color: #fff;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .search-bar:focus {
            border-color: #5865f2;
            outline: none;
        }

        /* Chat Area */
        .chat {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            height: 53px;
            background: #36393f;
            border-bottom: 1px solid #202225;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
        }

        .chat-header svg {
            opacity: 0.7;
            margin-right: 8px;
            transition: opacity 0.2s ease;
        }

        .chat-header span {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .chat-header .tools {
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        .chat-header button {
            background: none;
            border: none;
            color: #b9bbbe;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s ease, transform 0.1s ease;
        }

        .chat-header button:hover {
            color: #fff;
            transform: scale(1.1);
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #36393f;
            scroll-behavior: smooth;
        }

        .message-group {
            margin-bottom: 20px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            position: relative;
            padding: 2px 0;
            transition: background 0.2s ease;
        }

        .message:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .message.first svg.avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 16px;
            flex-shrink: 0;
            background: #5865f2;
            padding: 8px;
        }

        .message:not(.first) {
            padding-left: 56px;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 2px;
        }

        .message-header strong {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
        }

        .message-header span.timestamp {
            color: #72767d;
            font-size: 12px;
            margin-left: 8px;
            transition: opacity 0.2s ease;
        }

        .message:hover .timestamp {
            opacity: 1;
        }

        .message-text {
            color: #dcddde;
            font-size: 16px;
            word-wrap: break-word;
        }

        .message-text b {
            font-weight: 700;
        }

        .message-text i {
            font-style: italic;
        }

        .message-text pre {
            background: #2f3136;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            overflow-x: auto;
        }

        .message-text .mention {
            background: #5865f230;
            padding: 2px 4px;
            border-radius: 3px;
            color: #fff;
        }

        .message-text .reply {
            background: #ed424530;
            padding: 2px 4px;
            border-radius: 3px;
            color: #fff;
        }

        .message-text .spoiler {
            background: #72767d;
            color: #72767d;
            padding: 2px 4px;
            border-radius: 3px;
            cursor: pointer;
        }

        .message-text .spoiler.revealed {
            background: transparent;
            color: #dcddde;
        }

        .message-actions {
            position: absolute;
            top: -24px;
            right: 0;
            display: none;
            background: #18191c;
            padding: 4px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .message:hover .message-actions {
            display: flex;
        }

        .message-actions button {
            background: none;
            border: none;
            color: #b9bbbe;
            font-size: 16px;
            padding: 4px 8px;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.1s ease;
        }

        .message-actions button:hover {
            color: #fff;
            transform: scale(1.1);
        }

        .input-area {
            padding: 20px;
            background: #36393f;
            display: flex;
            align-items: center;
            border-top: 1px solid #202225;
            box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.1);
        }

        .input-area input {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 4px;
            background: #40444b;
            color: #dcddde;
            font-size: 16px;
            margin-right: 12px;
            transition: background 0.2s ease, box-shadow 0.2s ease;
        }

        .input-area input:focus {
            background: #4f545c;
            box-shadow: 0 0 4px rgba(88, 101, 242, 0.5);
            outline: none;
        }

        .input-area button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            background: #5865f2;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
            margin-left: 8px;
        }

        .input-area button:hover {
            background: #4752c4;
            transform: translateY(-2px);
        }

        .input-area button.secondary {
            background: #4f545c;
        }

        .input-area button.secondary:hover {
            background: #5c6169;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 480px;
            background: #2f3136;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            animation: modalFadeIn 0.2s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -55%);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }

        .modal h3 {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal input,
        .modal select,
        .modal textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #202225;
            border-radius: 4px;
            background: #40444b;
            color: #fff;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }

        .modal input:focus,
        .modal select:focus,
        .modal textarea:focus {
            border-color: #5865f2;
            outline: none;
        }

        .modal textarea {
            height: 100px;
            resize: none;
        }

        .modal button {
            padding: 12px 16px;
            margin: 8px 4px 0 0;
            border: none;
            border-radius: 4px;
            background: #5865f2;
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .modal button:hover {
            background: #4752c4;
            transform: translateY(-2px);
        }

        .modal button.cancel {
            background: #4f545c;
        }

        .modal button.cancel:hover {
            background: #5c6169;
        }

        .emoji-picker {
            max-height: 400px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .emoji-picker button {
            background: none;
            border: none;
            font-size: 24px;
            padding: 8px;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.1s ease;
        }

        .emoji-picker button:hover {
            background: rgba(79, 84, 92, 0.3);
            border-radius: 4px;
            transform: scale(1.2);
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #5865f2;
            padding: 12px 16px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
            animation: slideIn 0.3s ease;
            z-index: 3000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: #18191c;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 3000;
            display: none;
        }

        .context-menu button {
            display: block;
            width: 100%;
            padding: 8px 16px;
            background: none;
            border: none;
            color: #dcddde;
            text-align: left;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .context-menu button:hover {
            background: #5865f2;
            color: #fff;
        }

        .context-menu button:disabled {
            color: #72767d;
            cursor: not-allowed;
        }
    </style>
</head>

<body>
    <!-- Authentication Container -->
    <div id="auth-container">
        <div id="auth-box">
            <h2>Welcome to SuperChat</h2>
            <input type="email" id="email" placeholder="Email" required title="Enter your email">
            <input type="password" id="password" placeholder="Password" required title="Enter your password">
            <input type="text" id="username" placeholder="Username (for Register)" title="Choose a username">
            <button onclick="login()" title="Login to your account">Login</button>
            <button onclick="register()" title="Create a new account">Register</button>
            <button onclick="googleSignIn()" title="Sign in with Google">Sign In with Google</button>
            <button id="logout-btn" onclick="logout()" title="Logout from your account">Logout</button>
            <p id="auth-error"></p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app">
        <div class="sidebar">
            <div class="server-icon" onclick="selectServer('server1')" style="background: #5865f2;">
                <span class="server-tooltip">Server 1</span>
            </div>
            <div class="server-create" onclick="openServerModal()" title="Create a new server">+</div>
        </div>
        <div class="channels">
            <h3><span class="title">Server Name</span><button onclick="openChannelModal()" title="Create a new channel">
                    <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                </button></h3>
            <input type="text" class="search-bar" id="channel-search" placeholder="Search Channels" title="Search for a channel">
            <div class="channel" onclick="selectChannel('general')">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                </svg>
                General
            </div>
            <h3><span class="title">Members</span></h3>
            <div class="channel-members" id="member-list"></div>
        </div>
        <div class="chat">
            <div class="chat-header">
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                </svg>
                <span id="channel-name">#general</span>
                <div class="tools">
                    <button onclick="openSearchModal()" title="Search messages">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                    <button onclick="openPinnedModal()" title="View pinned messages">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5l-1.41 1.41L12 8l-4-4L6.59 5.41 5 7V18a2 2 0 002 2h10a2 2 0 002-2V7l-1.59-1.59L15 5z" />
                        </svg>
                    </button>
                    <button onclick="toggleAutoScroll()" title="Toggle auto-scroll">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                        </svg>
                    </button>
                    <button onclick="openProfile()" title="View and edit your profile">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                    </button>
                    <button onclick="openUserSettings()" title="Edit server settings">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                </div>
            </div>
            <div class="messages" id="messages"></div>
            <div class="input-area">
                <input type="text" id="message-input" placeholder="Message #general" title="Type your message here">
                <button class="secondary" onclick="openEmojiPicker()" title="Add an emoji">
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
                <button class="secondary" onclick="uploadFile()" title="Upload a file">
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v4h16v-4m-4-4l-4-4m0 0l-4 4m4-4v12" />
                    </svg>
                </button>
                <button class="secondary" onclick="createPoll()" title="Create a poll">
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                    </svg>
                </button>
                <button onclick="sendMessage()" title="Send message">
                    <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="server-modal"></div>
    <div class="modal" id="emoji-picker"></div>
    <div class="modal" id="user-settings"></div>
    <div class="modal" id="edit-message-modal"></div>
    <div class="modal" id="poll-modal"></div>
    <div class="modal" id="invite-modal"></div>
    <div class="modal" id="channel-modal"></div>
    <div class="modal" id="search-modal"></div>
    <div class="modal" id="profile-modal"></div>
    <div class="modal" id="pinned-modal"></div>
    <div class="modal" id="friends-modal"></div>
    <div class="context-menu" id="context-menu"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9tKggdz9mAb6vYgp1DoyAyxTQmu50Cu8",
            authDomain: "grill-grill.firebaseapp.com",
            databaseURL: "https://grill-grill-default-rtdb.firebaseio.com",
            projectId: "grill-grill",
            storageBucket: "grill-grill.firebasestorage.app",
            messagingSenderId: "277545785806",
            appId: "1:277545785806:web:0ddc9c6b1a68777b7cf39f"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const storage = firebase.storage();

        // Global Variables
        let currentUser = null;
        let currentServer = null;
        let currentChannel = 'general';
        let theme = 'dark';
        let userData = {};
        let serverData = {};
        let typingTimeout = null;
        const serverColors = ['#5865f2', '#57f287', '#fee75c', '#eb459e', '#ed4245', '#faa61a', '#43b581', '#7289da', '#f04747', '#d83c3e'];
        let autoScroll = true;
        let notificationSound = new Audio('https://notificationsounds.com/storage/sounds/file-sounds-1148-ding.mp3');
        const MAIN_SERVER_ID = 'main-server';

        // Utility Functions
        /**
         * Displays a modal with the given content
         * @param {string} id - Modal ID
         * @param {string} content - HTML content for the modal
         */
        function showModal(id, content) {
            const modal = document.getElementById(id);
            modal.innerHTML = content;
            modal.style.display = 'block';
            modal.querySelector('input')?.focus();
        }

        /**
         * Hides a modal by ID
         * @param {string} id - Modal ID
         */
        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        /**
         * Shows a temporary notification with optional sound
         * @param {string} message - Notification text
         * @param {boolean} playSound - Whether to play notification sound
         */
        function showNotification(message, playSound = true) {
            const div = document.createElement('div');
            div.className = 'notification';
            div.textContent = message;
            document.body.appendChild(div);
            if (playSound && userData.settings?.notifications) notificationSound.play().catch(() => {});
            setTimeout(() => div.remove(), 5000);
        }

        /**
         * Shows a loading spinner in the messages div
         */
        function showLoading() {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `
        <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
            <div style="border: 4px solid #5865f2; border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        </div>
    `;
            document.styleSheets[0].insertRule(`
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `, 0);
        }

        /**
         * Formats a timestamp to a readable time
         * @param {number} timestamp - Unix timestamp
         * @returns {string} Formatted time
         */
        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        /**
         * Escapes HTML to prevent XSS
         * @param {string} text - Input text
         * @returns {string} Escaped text
         */
        function escapeHtml(text) {
            return text.replace(/&/g, '&').replace(/</g, '<').replace(/>/g, '>');
        }

        // Authentication Functions
        /**
         * Logs in a user with email and password
         */
        function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            if (!email || !password) return showError('Please fill in all fields');
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => handleAuthSuccess(userCredential.user))
                .catch(showError);
        }

        /**
         * Registers a new user
         */
        function register() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value.trim();
            if (!email || !password || !username) return showError('Please fill in all fields');
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    db.ref(`users/${user.uid}`).set({
                            username,
                            email,
                            status: 'online',
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            settings: {
                                theme: 'dark',
                                notifications: true
                            }, // Default theme set to dark
                            profile: {
                                bio: '',
                                avatar: '',
                                bannerColor: '#5865f2'
                            },
                            friends: {}
                        }).then(() => handleAuthSuccess(user))
                        .catch(err => showNotification('Failed to register user data: ' + err.message));
                })
                .catch(showError);
        }

        /**
         * Signs in with Google
         */
        function googleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(userCredential => {
                    const user = userCredential.user;
                    db.ref(`users/${user.uid}`).update({
                            username: user.displayName,
                            email: user.email,
                            status: 'online',
                            createdAt: firebase.database.ServerValue.TIMESTAMP,
                            settings: {
                                theme: 'dark',
                                notifications: true
                            }, // Default theme set to dark
                            profile: {
                                bio: '',
                                avatar: '',
                                bannerColor: '#5865f2'
                            },
                            friends: {}
                        }).then(() => handleAuthSuccess(user))
                        .catch(err => showNotification('Failed to update Google user data: ' + err.message));
                })
                .catch(showError);
        }

        /**
         * Logs out the current user
         */
        function logout() {
            db.ref(`users/${currentUser.uid}`).update({
                    status: 'offline'
                })
                .then(() => {
                    auth.signOut().then(() => {
                        currentUser = null;
                        document.getElementById('app').style.display = 'none';
                        document.getElementById('auth-container').style.display = 'flex';
                        document.getElementById('logout-btn').style.display = 'none';
                        showNotification('Logged out');
                    }).catch(err => showNotification('Logout failed: ' + err.message));
                })
                .catch(err => showNotification('Failed to update status: ' + err.message));
        }

        /**
         * Handles successful authentication and joins Main Server
         * @param {Object} user - Firebase user object
         */
        function handleAuthSuccess(user) {
            currentUser = user;
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            document.getElementById('logout-btn').style.display = 'block';
            loadUserData();
            loadServers();
            joinMainServer();
            showNotification(`Welcome back, ${userData.username || 'User'}!`);
        }

        /**
         * Ensures the user joins the Main Server
         */
        function joinMainServer() {
            db.ref(`servers/${MAIN_SERVER_ID}`).transaction(server => {
                if (!server) {
                    return {
                        name: 'Main Server',
                        inviteCode: 'public',
                        channels: {
                            general: {
                                type: 'text',
                                createdAt: firebase.database.ServerValue.TIMESTAMP,
                                topic: 'General chat for everyone'
                            }
                        },
                        members: {
                            [currentUser.uid]: {
                                role: 'member',
                                nickname: userData.username,
                                joinedAt: firebase.database.ServerValue.TIMESTAMP
                            }
                        },
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        settings: {
                            welcomeMessage: 'Welcome to the Main Server!'
                        }
                    };
                } else {
                    server.members = server.members || {};
                    if (!server.members[currentUser.uid]) {
                        server.members[currentUser.uid] = {
                            role: 'member',
                            nickname: userData.username,
                            joinedAt: firebase.database.ServerValue.TIMESTAMP
                        };
                    }
                    return server;
                }
            }).then(() => {
                if (!currentServer) selectServer(MAIN_SERVER_ID);
            }).catch(err => showNotification('Failed to join Main Server: ' + err.message));
        }

        /**
         * Displays an authentication error
         * @param {Object} error - Error object
         */
        function showError(error) {
            document.getElementById('auth-error').textContent = error.message || 'An error occurred';
        }

        // User Data Management
        /**
         * Loads and updates user data
         */
        function loadUserData() {
            db.ref(`users/${currentUser.uid}`).on('value', snap => {
                userData = snap.val() || {};
                theme = userData.settings?.theme || 'dark'; // Default to dark if no theme set
                applyTheme();
                updateUI();
            }, err => showNotification('Failed to load user data: ' + err.message));
        }

        // Server Management
        /**
         * Loads all servers and renders them in the sidebar
         */
        function loadServers() {
            showLoading();
            db.ref('servers').on('value', snap => {
                serverData = snap.val() || {};
                const sidebar = document.querySelector('.sidebar');
                sidebar.innerHTML = '<div class="server-create" onclick="openServerModal()" title="Create a new server">+</div>';
                let colorIndex = 0;
                Object.keys(serverData).forEach(server => {
                    const div = document.createElement('div');
                    div.className = `server-icon ${server === currentServer ? 'active' : ''}`;
                    div.style.background = serverColors[colorIndex % serverColors.length];
                    div.onclick = () => selectServer(server);
                    div.innerHTML = `<span class="server-tooltip">${serverData[server].name}</span>`;
                    sidebar.insertBefore(div, sidebar.lastChild);
                    colorIndex++;
                });
                if (!currentServer && Object.keys(serverData).length > 0) {
                    selectServer(MAIN_SERVER_ID);
                }
            }, err => showNotification('Failed to load servers: ' + err.message));
        }

        /**
         * Selects a server and loads its #general channel
         * @param {string} server - Server ID
         */
        function selectServer(server) {
            currentServer = server;
            currentChannel = 'general'; // Reset to general channel
            loadChannels();
            loadMessages(); // Load #general chat immediately
            updateUI();
        }

        /**
         * Opens the server creation modal
         */
        function openServerModal() {
            showModal('server-modal', `
        <h3>Create a Server</h3>
        <input id="server-name" placeholder="Server Name" required title="Enter server name">
        <button onclick="createServer()">Create</button>
        <button class="cancel" onclick="closeModal('server-modal')">Cancel</button>
    `);
        }

        /**
         * Creates a new server with reliability checks
         */
        function createServer() {
            const name = document.getElementById('server-name').value.trim();
            if (!name) return showNotification('Server name is required');
            if (name === 'Main Server') return showNotification('Cannot use reserved name "Main Server"');

            db.ref('servers').once('value', snap => {
                const servers = snap.val() || {};
                if (Object.values(servers).some(s => s.name === name)) {
                    return showNotification('Server name already exists');
                }

                const serverId = db.ref('servers').push().key;
                let attempts = 0;
                const maxAttempts = 3;

                function tryCreate() {
                    db.ref(`servers/${serverId}`).set({
                        name,
                        inviteCode: Math.random().toString(36).substring(2, 8),
                        channels: {
                            general: {
                                type: 'text',
                                createdAt: firebase.database.ServerValue.TIMESTAMP,
                                topic: 'General chat'
                            }
                        },
                        members: {
                            [currentUser.uid]: {
                                role: 'admin',
                                nickname: userData.username,
                                joinedAt: firebase.database.ServerValue.TIMESTAMP
                            }
                        },
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        settings: {
                            welcomeMessage: `Welcome to ${name}!`
                        }
                    }).then(() => {
                        closeModal('server-modal');
                        selectServer(serverId); // Select new server and load #general
                        showNotification(`Created server: ${name}`);
                        logAudit(`Created server ${serverId} named ${name}`);
                    }).catch(err => {
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(tryCreate, 1000);
                        } else {
                            showNotification('Failed to create server after retries: ' + err.message);
                        }
                    });
                }
                tryCreate();
            }).catch(err => showNotification('Failed to check server names: ' + err.message));
        }

        /**
         * Opens the invite modal for the current server
         */
        function openInviteModal() {
            const inviteCode = serverData[currentServer]?.inviteCode;
            showModal('invite-modal', `
        <h3>Invite Friends</h3>
        <input id="invite-code" value="${inviteCode}" readonly title="Server invite code">
        <button onclick="copyInviteCode()">Copy</button>
        <button class="cancel" onclick="closeModal('invite-modal')">Close</button>
    `);
        }

        /**
         * Copies the invite code to the clipboard
         */
        function copyInviteCode() {
            const code = document.getElementById('invite-code');
            code.select();
            document.execCommand('copy');
            showNotification('Invite code copied!');
        }

        // Channel Management
        /**
         * Loads channels and members for the current server
         */
        function loadChannels() {
            const channelsDiv = document.querySelector('.channels');
            channelsDiv.innerHTML = `
        <h3>
            <span class="title">${serverData[currentServer]?.name || 'Server'}</span>
            <button onclick="openChannelModal()" title="Create a new channel">
                <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
            </button>
        </h3>
        <input type="text" class="search-bar" id="channel-search" placeholder="Search Channels" title="Search for a channel">
    `;

            db.ref(`servers/${currentServer}/channels`).on('value', snap => {
                const channels = snap.val() || {};
                const channelKeys = Object.keys(channels);

                // Sort channels to put #general at the top
                const sortedChannels = channelKeys.sort((a, b) => {
                    if (a === 'general') return -1;
                    if (b === 'general') return 1;
                    return a.localeCompare(b);
                });

                sortedChannels.forEach(channel => {
                    const div = document.createElement('div');
                    div.className = `channel ${channel === currentChannel ? 'active' : ''}`;
                    div.innerHTML = `
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                </svg>
                ${channel}
            `;
                    div.onclick = () => selectChannel(channel);
                    div.oncontextmenu = (e) => openChannelContext(e, channel);
                    div.title = channels[channel].topic || 'No topic set';
                    channelsDiv.appendChild(div);
                });

                channelsDiv.innerHTML += `
            <h4>
                <span class="title">Members (${Object.keys(serverData[currentServer]?.members || {}).length})</span>
                <button onclick="openFriendsModal()" title="Manage friends">
                    <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </h4>
            <div class="channel-members" id="member-list"></div>
        `;
                updateMemberList();
                filterChannels();
            }, err => showNotification('Failed to load channels: ' + err.message));
        }

        /**
         * Selects a channel and loads its chat
         * @param {string} channel - Channel name
         */
        function selectChannel(channel) {
            currentChannel = channel;
            document.getElementById('channel-name').textContent = `#${channel}`;
            document.getElementById('message-input').placeholder = `Message #${channel}`;
            document.querySelectorAll('.channel').forEach(el => el.classList.remove('active'));
            const activeChannel = document.querySelector(`.channel[onclick="selectChannel('${channel}')"]`);
            if (activeChannel) activeChannel.classList.add('active');
            loadMessages();
        }

        /**
         * Filters channels based on search input
         */
        function filterChannels() {
            const search = document.getElementById('channel-search');
            search.addEventListener('input', () => {
                const term = search.value.toLowerCase();
                document.querySelectorAll('.channel').forEach(channel => {
                    const name = channel.textContent.trim().toLowerCase();
                    channel.style.display = name.includes(term) ? 'flex' : 'none';
                });
            });
        }

        /**
         * Opens the channel creation modal
         */
        function openChannelModal() {
            showModal('channel-modal', `
        <h3>Create Channel</h3>
        <input id="channel-name" placeholder="Channel Name" required title="Enter channel name">
        <input id="channel-topic" placeholder="Channel Topic" title="Set a topic (optional)">
        <button onclick="createChannel()">Create</button>
        <button class="cancel" onclick="closeModal('channel-modal')">Cancel</button>
    `);
        }

        /**
         * Creates a new channel with reliability checks
         */
        function createChannel() {
            const name = document.getElementById('channel-name').value.trim();
            const topic = document.getElementById('channel-topic').value.trim();
            if (!name) return showNotification('Channel name is required');

            // Reference to the channels node for the current server
            const channelsRef = db.ref(`servers/${currentServer}/channels`);

            // Check for existing channel and create if not present
            channelsRef.once('value', snap => {
                const channels = snap.val() || {};
                if (channels[name]) return showNotification('Channel name already exists');

                let attempts = 0;
                const maxAttempts = 3;

                function tryCreate() {
                    channelsRef.child(name).set({
                        type: 'text',
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        topic: topic || 'No topic set'
                    }).then(() => {
                        closeModal('channel-modal');
                        selectChannel(name); // Load the new channel's chat
                        showNotification(`Created channel: #${name}`);
                        logAudit(`Created channel ${name} in server ${currentServer}`);
                    }).catch(err => {
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(tryCreate, 1000);
                        } else {
                            showNotification('Failed to create channel after retries: ' + err.message);
                        }
                    });
                }
                tryCreate();
            }).catch(err => showNotification('Failed to check channel names: ' + err.message));
        }

        // Member Management
        /**
         * Updates the member list with online status
         */
        function updateMemberList() {
            db.ref(`servers/${currentServer}/members`).on('value', snap => {
                const members = snap.val() || {};
                const list = document.getElementById('member-list');
                list.innerHTML = '';
                Object.entries(members).forEach(([uid, data]) => {
                    db.ref(`users/${uid}`).once('value', userSnap => {
                        const user = userSnap.val();
                        if (user) {
                            const div = document.createElement('div');
                            div.className = `member ${user.status === 'online' ? 'online' : ''}`;
                            div.textContent = data.nickname || user.username;
                            div.onclick = () => openMemberContext(uid, data.role);
                            div.title = `${user.status === 'online' ? 'Online' : 'Offline'} - ${user.profile?.bio || 'No bio'}`;
                            list.appendChild(div);
                        }
                    });
                });
            }, err => showNotification('Failed to load members: ' + err.message));
        }

        /**
         * Opens a context menu for a member
         * @param {string} uid - User ID
         * @param {string} role - User role
         */
        function openMemberContext(uid, role) {
            const isAdmin = serverData[currentServer]?.members[currentUser.uid]?.role === 'admin';
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.top = `${event.pageY}px`;
            menu.style.left = `${event.pageX}px`;
            menu.innerHTML = `
        <button onclick="kickMember('${uid}')" ${!isAdmin || uid === currentUser.uid ? 'disabled' : ''}>Kick</button>
        <button onclick="changeRole('${uid}', '${role === 'admin' ? 'member' : 'admin'}')" ${!isAdmin || uid === currentUser.uid ? 'disabled' : ''}>${role === 'admin' ? 'Demote to Member' : 'Promote to Admin'}</button>
        <button onclick="addFriend('${uid}')">Add Friend</button>
        <button onclick="closeContextMenu()">Close</button>
    `;
            document.addEventListener('click', closeContextMenu, {
                once: true
            });
        }

        /**
         * Kicks a member from the server
         * @param {string} uid - User ID
         */
        function kickMember(uid) {
            db.ref(`servers/${currentServer}/members/${uid}`).remove()
                .then(() => {
                    closeContextMenu();
                    showNotification('Member kicked');
                    logAudit(`Kicked user ${uid} from server ${currentServer}`);
                })
                .catch(err => showNotification('Failed to kick member: ' + err.message));
        }

        /**
         * Changes a member's role
         * @param {string} uid - User ID
         * @param {string} newRole - New role
         */
        function changeRole(uid, newRole) {
            db.ref(`servers/${currentServer}/members/${uid}`).update({
                    role: newRole
                })
                .then(() => {
                    closeContextMenu();
                    showNotification(`Role changed to ${newRole}`);
                    logAudit(`Changed role of ${uid} to ${newRole} in server ${currentServer}`);
                })
                .catch(err => showNotification('Failed to change role: ' + err.message));
        }

        // Messaging
        /**
         * Sends a message with retry logic
         */
        async function sendMessage() {
            const input = document.getElementById('message-input');
            const text = escapeHtml(input.value.trim());
            if (!text || !currentUser) return;

            let username = userData.username;
            if (!username) {
                const userSnap = await db.ref(`users/${currentUser.uid}`).once('value');
                username = userSnap.val()?.username || 'Unknown';
                userData.username = username;
            }

            const message = {
                user: currentUser.uid,
                username: username,
                text: parseFormatting(text),
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                server: currentServer,
                channel: currentChannel,
                edited: false,
                reactions: {},
                starred: false
            };

            let attempts = 0;
            const maxAttempts = 3;
            while (attempts < maxAttempts) {
                try {
                    await db.ref(`messages/${currentServer}/${currentChannel}`).push(message);
                    input.value = '';
                    checkMentions(text);
                    clearTyping();
                    if (autoScroll) document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
                    break;
                } catch (err) {
                    attempts++;
                    if (attempts === maxAttempts) showNotification('Failed to send message after retries: ' + err.message);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        /**
         * Loads and groups messages by user with loading spinner
         */
        function loadMessages() {
            const messagesDiv = document.getElementById('messages');
            showLoading();
            db.ref(`servers/${currentServer}/channels/${currentChannel}`).once('value', snap => {
                const channelData = snap.val();
                messagesDiv.innerHTML = '';
                if (channelData?.topic) {
                    const topicDiv = document.createElement('div');
                    topicDiv.className = 'message';
                    topicDiv.innerHTML = `<div class="message-content"><em>Topic: ${channelData.topic}</em></div>`;
                    messagesDiv.appendChild(topicDiv);
                }
            }).catch(err => showNotification('Failed to load channel topic: ' + err.message));

            db.ref(`messages/${currentServer}/${currentChannel}`).limitToLast(100).on('value', snap => {
                messagesDiv.innerHTML = '';
                const messages = snap.val() || {};
                const sortedMessages = Object.entries(messages).sort((a, b) => a[1].timestamp - b[1].timestamp);
                let lastUser = null;
                sortedMessages.forEach(([id, msg], index) => {
                    const isFirst = lastUser !== msg.user;
                    const group = isFirst || index === 0 ? document.createElement('div') : messagesDiv.lastChild;
                    if (isFirst) {
                        group.className = 'message-group';
                        messagesDiv.appendChild(group);
                    }
                    const div = document.createElement('div');
                    div.className = `message ${isFirst ? 'first' : ''}`;
                    div.dataset.id = id;
                    const reactionStr = Object.entries(msg.reactions || {}).map(([emoji, count]) => `${emoji} ${count}`).join(' ');
                    div.innerHTML = `
                ${isFirst ? `
                    <svg class="avatar" width="40" height="40" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 19.071a8 8 0 1113.858-8l3.536 3.536M15 9H9m6 0V3" />
                    </svg>
                ` : ''}
                <div class="message-content">
                    ${isFirst ? `
                        <div class="message-header">
                            <strong>${msg.username}</strong>
                            <span class="timestamp">${formatTimestamp(msg.timestamp)}${msg.edited ? ' (edited)' : ''}</span>
                        </div>
                    ` : ''}
                    <div class="message-text">${msg.text}${reactionStr ? `<br><span>${reactionStr}</span>` : ''}</div>
                    <div class="message-actions">
                        <button onclick="editMessage('${id}', '${msg.text}')" title="Edit message">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15.828l-2.828.586.586-2.828L16.414 6.586z" />
                            </svg>
                        </button>
                        <button onclick="deleteMessage('${id}')" title="Delete message">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a1 1 0 011 1v1H9V4a1 1 0 011-1z" />
                            </svg>
                        </button>
                        <button onclick="pinMessage('${id}')" title="Pin message">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5l-1.41 1.41L12 8l-4-4L6.59 5.41 5 7V18a2 2 0 002 2h10a2 2 0 002-2V7l-1.59-1.59L15 5z" />
                            </svg>
                        </button>
                        <button onclick="reactMessage('${id}', '')" title="React with "></button>
                        <button onclick="reactMessage('${id}', '')" title="React with "></button>
                        <button onclick="reactMessage('${id}', '')" title="React with "></button>
                        <button onclick="replyToMessage('${id}')" title="Reply to message">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
                            </svg>
                        </button>
                        <button onclick="forwardMessage('${id}')" title="Forward message">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" />
                            </svg>
                        </button>
                        <button onclick="starMessage('${id}', ${msg.starred})" title="${msg.starred ? 'Unstar' : 'Star'} message">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="${msg.starred ? 'currentColor' : 'none'}" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                            </svg>
                        </button>
                        <button onclick="copyMessage('${id}')" title="Copy message text">
                            <svg width="16" height="16" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
                    group.appendChild(div);
                    lastUser = msg.user;
                });
                if (autoScroll) messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }, err => showNotification('Failed to load messages: ' + err.message));
        }

        /**
         * Edits an existing message
         * @param {string} id - Message ID
         * @param {string} oldText - Current message text
         */
        function editMessage(id, oldText) {
            showModal('edit-message-modal', `
        <h3>Edit Message</h3>
        <input id="edit-text" value="${oldText.replace(/<[^>]+>/g, '')}" required title="Edit your message">
        <button onclick="saveEdit('${id}')">Save</button>
        <button class="cancel" onclick="closeModal('edit-message-modal')">Cancel</button>
    `);
        }

        /**
         * Saves an edited message
         * @param {string} id - Message ID
         */
        function saveEdit(id) {
            const newText = escapeHtml(document.getElementById('edit-text').value.trim());
            if (newText) {
                db.ref(`messages/${currentServer}/${currentChannel}/${id}`).update({
                    text: parseFormatting(newText),
                    edited: true,
                    editedAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => {
                    closeModal('edit-message-modal');
                    showNotification('Message edited');
                }).catch(err => showNotification('Failed to edit message: ' + err.message));
            }
        }

        /**
         * Deletes a message
         * @param {string} id - Message ID
         */
        function deleteMessage(id) {
            if (confirm('Delete this message?')) {
                db.ref(`messages/${currentServer}/${currentChannel}/${id}`).remove()
                    .then(() => showNotification('Message deleted'))
                    .catch(err => showNotification('Failed to delete message: ' + err.message));
            }
        }

        /**
         * Pins a message to the channel
         * @param {string} id - Message ID
         */
        function pinMessage(id) {
            db.ref(`servers/${currentServer}/pinned/${currentChannel}/${id}`).set({
                    pinnedAt: firebase.database.ServerValue.TIMESTAMP
                }).then(() => showNotification('Message pinned'))
                .catch(err => showNotification('Failed to pin message: ' + err.message));
        }

        /**
         * Adds a reaction to a message
         * @param {string} id - Message ID
         * @param {string} emoji - Emoji to react with
         */
        function reactMessage(id, emoji) {
            db.ref(`messages/${currentServer}/${currentChannel}/${id}/reactions/${emoji}`).transaction(count => (count || 0) + 1)
                .then(() => showNotification(`Reacted with ${emoji}`))
                .catch(err => showNotification('Failed to react: ' + err.message));
        }

        /**
         * Prepares a reply to a message
         * @param {string} id - Message ID
         */
        function replyToMessage(id) {
            const input = document.getElementById('message-input');
            input.value = `@reply:${id} `;
            input.focus();
        }

        /**
         * Forwards a message within the channel
         * @param {string} id - Message ID
         */
        function forwardMessage(id) {
            db.ref(`messages/${currentServer}/${currentChannel}/${id}`).once('value', snap => {
                const msg = snap.val();
                const text = `[Forwarded from #${currentChannel}] ${msg.username}: ${msg.text}`;
                db.ref(`messages/${currentServer}/${currentChannel}`).push({
                        user: currentUser.uid,
                        username: userData.username,
                        text: parseFormatting(text),
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        server: currentServer,
                        channel: currentChannel
                    }).then(() => showNotification('Message forwarded'))
                    .catch(err => showNotification('Failed to forward message: ' + err.message));
            });
        }

        /**
         * Stars or unstars a message
         * @param {string} id - Message ID
         * @param {boolean} currentState - Current starred state
         */
        function starMessage(id, currentState) {
            db.ref(`messages/${currentServer}/${currentChannel}/${id}`).update({
                    starred: !currentState
                })
                .then(() => showNotification(currentState ? 'Message unstarred' : 'Message starred'))
                .catch(err => showNotification('Failed to star message: ' + err.message));
        }

        /**
         * Copies message text to clipboard
         * @param {string} id - Message ID
         */
        function copyMessage(id) {
            db.ref(`messages/${currentServer}/${currentChannel}/${id}`).once('value', snap => {
                const msg = snap.val();
                navigator.clipboard.writeText(msg.text.replace(/<[^>]+>/g, ''))
                    .then(() => showNotification('Message copied to clipboard'))
                    .catch(err => showNotification('Failed to copy message: ' + err.message));
            });
        }

        /**
         * Formats message text with rich formatting
         * @param {string} text - Input text
         * @returns {string} Formatted HTML
         */
        function parseFormatting(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.+?)\*/g, '<i>$1</i>')
                .replace(/```(.+?)```/g, '<pre>$1</pre>')
                .replace(/\|\|(.+?)\|\|/g, '<span class="spoiler" onclick="this.classList.toggle(\'revealed\')">$1</span>')
                .replace(/@(\w+)/g, '<span class="mention">@$1</span>')
                .replace(/@reply:(\w+)/g, '<span class="reply">[Replying]</span>');
        }

        /**
         * Checks for mentions and sends notifications
         * @param {string} text - Message text
         */
        function checkMentions(text) {
            const mentions = text.match(/@(\w+)/g);
            if (mentions) mentions.forEach(m => {
                const username = m.slice(1);
                db.ref('users').orderByChild('username').equalTo(username).once('value', snap => {
                    if (snap.exists()) showNotification(`@${username} mentioned you!`);
                });
            });
        }

        // File Upload
        /**
         * Uploads a file to Firebase Storage
         */
        function uploadFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.pdf,.txt';
            input.onchange = () => {
                const file = input.files[0];
                if (file.size > 8e6) return showNotification('File too large (max 8MB)');
                const ref = storage.ref(`files/${currentServer}/${currentChannel}/${Date.now()}_${file.name}`);
                ref.put(file).then(() => {
                    ref.getDownloadURL().then(url => {
                        const message = {
                            user: currentUser.uid,
                            username: userData.username,
                            text: `<a href="${url}" target="_blank">${file.name}</a>`,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            server: currentServer,
                            channel: currentChannel,
                            type: 'file'
                        };
                        db.ref(`messages/${currentServer}/${currentChannel}`).push(message)
                            .then(() => showNotification('File uploaded'))
                            .catch(err => showNotification('Upload failed: ' + err.message));
                    });
                }).catch(err => showNotification('Upload failed: ' + err.message));
            };
            input.click();
        }

        // Profile Management
        /**
         * Opens the profile modal with customization options
         */
        function openProfile() {
            showModal('profile-modal', `
        <h3>Your Profile</h3>
        <input id="profile-username" value="${userData.username}" placeholder="Username" required title="Your username">
        <textarea id="profile-bio" placeholder="Bio" title="Tell us about yourself">${userData.profile?.bio || ''}</textarea>
        <input id="profile-avatar" type="file" accept="image/*" title="Upload a profile picture">
        <input id="profile-status" value="${userData.statusMessage || ''}" placeholder="Custom Status" title="Set a status message">
        <select id="profile-banner" title="Choose a banner color">
            ${serverColors.map(color => `<option value="${color}" ${userData.profile?.bannerColor === color ? 'selected' : ''}>${color}</option>`).join('')}
        </select>
        <select id="profile-theme" title="Select app theme">
            <option value="dark" ${theme === 'dark' ? 'selected' : ''}>Dark</option>
            <option value="light" ${theme === 'light' ? 'selected' : ''}>Light</option>
        </select>
        <select id="profile-notifications" title="Enable/disable notifications">
            <option value="true" ${userData.settings?.notifications ? 'selected' : ''}>Enabled</option>
            <option value="false" ${!userData.settings?.notifications ? 'selected' : ''}>Disabled</option>
        </select>
        <button onclick="saveProfile()">Save</button>
        <button onclick="logout()" style="background: #ed4245;" title="Logout from SuperChat">Logout</button>
        <button class="cancel" onclick="closeModal('profile-modal')">Cancel</button>
    `);
        }

        /**
         * Saves profile changes
         */
        function saveProfile() {
            const username = document.getElementById('profile-username').value.trim();
            const bio = document.getElementById('profile-bio').value.trim();
            const status = document.getElementById('profile-status').value.trim();
            const bannerColor = document.getElementById('profile-banner').value;
            const newTheme = document.getElementById('profile-theme').value;
            const notifications = document.getElementById('profile-notifications').value === 'true';
            const avatarFile = document.getElementById('profile-avatar').files[0];

            if (!username) return showNotification('Username is required');

            const updates = {};
            updates[`users/${currentUser.uid}/username`] = username;
            updates[`servers/${currentServer}/members/${currentUser.uid}/nickname`] = username;
            updates[`users/${currentUser.uid}/statusMessage`] = status;
            updates[`users/${currentUser.uid}/profile/bio`] = bio;
            updates[`users/${currentUser.uid}/profile/bannerColor`] = bannerColor;
            updates[`users/${currentUser.uid}/settings/theme`] = newTheme;
            updates[`users/${currentUser.uid}/settings/notifications`] = notifications;

            if (avatarFile) {
                const ref = storage.ref(`avatars/${currentUser.uid}/${Date.now()}_${avatarFile.name}`);
                ref.put(avatarFile).then(() => {
                    ref.getDownloadURL().then(url => {
                        updates[`users/${currentUser.uid}/profile/avatar`] = url;
                        db.ref().update(updates)
                            .then(() => {
                                applyTheme(newTheme);
                                closeModal('profile-modal');
                                showNotification('Profile updated');
                            })
                            .catch(err => showNotification('Failed to update profile: ' + err.message));
                    });
                }).catch(err => showNotification('Avatar upload failed: ' + err.message));
            } else {
                db.ref().update(updates)
                    .then(() => {
                        applyTheme(newTheme);
                        closeModal('profile-modal');
                        showNotification('Profile updated');
                    })
                    .catch(err => showNotification('Failed to update profile: ' + err.message));
            }
        }

        /**
         * Applies the selected theme
         * @param {string} newTheme - Theme to apply
         */
        function applyTheme() {
            document.body.style.background = theme === 'dark' ? '#36393f' : '#fff';
            document.body.style.color = theme === 'dark' ? '#dcddde' : '#2f3136';
            document.querySelector('.sidebar').style.background = theme === 'dark' ? '#202225' : '#e3e5e8';
            document.querySelector('.channels').style.background = theme === 'dark' ? '#2f3136' : '#f2f3f5';
            document.querySelector('.chat').style.background = theme === 'dark' ? '#36393f' : '#fff';
        }

        // Server Settings
        /**
         * Opens the server settings modal
         */
        function openUserSettings() {
            showModal('user-settings', `
        <h3>Server Settings</h3>
        <input id="nickname" value="${serverData[currentServer]?.members[currentUser.uid]?.nickname || ''}" placeholder="Server Nickname" title="Set your nickname for this server">
        <input id="welcome-message" value="${serverData[currentServer]?.settings?.welcomeMessage || ''}" placeholder="Welcome Message" title="Set a welcome message for new members">
        <button onclick="saveSettings()">Save</button>
        <button class="cancel" onclick="closeModal('user-settings')">Cancel</button>
    `);
        }

        /**
         * Saves server-specific settings
         */
        function saveSettings() {
            const nickname = document.getElementById('nickname').value.trim();
            const welcomeMessage = document.getElementById('welcome-message').value.trim();
            const updates = {};
            if (nickname) updates[`servers/${currentServer}/members/${currentUser.uid}/nickname`] = nickname;
            if (welcomeMessage) updates[`servers/${currentServer}/settings/welcomeMessage`] = welcomeMessage;

            if (Object.keys(updates).length > 0) {
                db.ref().update(updates)
                    .then(() => {
                        closeModal('user-settings');
                        showNotification('Server settings updated');
                        logAudit(`Updated server settings for ${currentServer}`);
                    })
                    .catch(err => showNotification('Failed to update settings: ' + err.message));
            } else {
                closeModal('user-settings');
            }
        }

        // Emoji Picker
        /**
         * Opens the emoji picker modal
         */
        function openEmojiPicker() {
            const emojis = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
            showModal('emoji-picker', `
        <h3>Pick an Emoji</h3>
        <div class="emoji-picker">
            ${emojis.map(e => `<button onclick="addEmoji('${e}')">${e}</button>`).join('')}
        </div>
        <button class="cancel" onclick="closeModal('emoji-picker')">Close</button>
    `);
        }

        /**
         * Adds an emoji to the message input
         * @param {string} emoji - Emoji to add
         */
        function addEmoji(emoji) {
            document.getElementById('message-input').value += emoji;
            closeModal('emoji-picker');
        }

        // Polls
        /**
         * Opens the poll creation modal
         */
        function createPoll() {
            showModal('poll-modal', `
        <h3>Create a Poll</h3>
        <input id="poll-question" placeholder="Question" required title="Enter poll question">
        <input id="poll-option1" placeholder="Option 1" required title="Enter first option">
        <input id="poll-option2" placeholder="Option 2" required title="Enter second option">
        <button onclick="savePoll()">Create</button>
        <button class="cancel" onclick="closeModal('poll-modal')">Cancel</button>
    `);
        }

        /**
         * Saves a new poll
         */
        function savePoll() {
            const question = escapeHtml(document.getElementById('poll-question').value.trim());
            const option1 = escapeHtml(document.getElementById('poll-option1').value.trim());
            const option2 = escapeHtml(document.getElementById('poll-option2').value.trim());
            if (!question || !option1 || !option2) return showNotification('All fields are required');
            const poll = {
                user: currentUser.uid,
                username: userData.username,
                text: `<b>Poll: ${question}</b><br>1. ${option1} (0 votes)<br>2. ${option2} (0 votes)<br><button onclick="votePoll('${currentServer}-${currentChannel}', 1)">Vote 1</button> <button onclick="votePoll('${currentServer}-${currentChannel}', 2)">Vote 2</button>`,
                timestamp: firebase.database.ServerValue.TIMESTAMP,
                server: currentServer,
                channel: currentChannel,
                type: 'poll',
                votes: {}
            };
            const pollRef = db.ref(`messages/${currentServer}/${currentChannel}`).push(poll);
            pollRef.then(key => {
                const pollId = key.key;
                db.ref(`messages/${currentServer}/${currentChannel}/${pollId}/votes`).on('value', snap => {
                    const votes = snap.val() || {};
                    let count1 = 0,
                        count2 = 0;
                    Object.values(votes).forEach(vote => vote === 1 ? count1++ : count2++);
                    db.ref(`messages/${currentServer}/${currentChannel}/${pollId}`).update({
                        text: `<b>Poll: ${question}</b><br>1. ${option1} (${count1} votes)<br>2. ${option2} (${count2} votes)<br><button onclick="votePoll('${pollId}', 1)">Vote 1</button> <button onclick="votePoll('${pollId}', 2)">Vote 2</button>`
                    });
                });
            }).catch(err => showNotification('Failed to create poll: ' + err.message));
            closeModal('poll-modal');
            showNotification('Poll created');
        }

        /**
         * Votes on a poll
         * @param {string} id - Poll message ID
         * @param {number} option - Option number (1 or 2)
         */
        function votePoll(id, option) {
            db.ref(`messages/${currentServer}/${currentChannel}/${id}/votes/${currentUser.uid}`).set(option)
                .then(() => showNotification(`Voted for option ${option}`))
                .catch(err => showNotification('Failed to vote: ' + err.message));
        }

        // Message Search
        /**
         * Opens the message search modal
         */
        function openSearchModal() {
            showModal('search-modal', `
        <h3>Search Messages</h3>
        <input id="search-query" placeholder="Enter search term" required title="Search messages">
        <button onclick="searchMessages()">Search</button>
        <button class="cancel" onclick="closeModal('search-modal')">Cancel</button>
        <div id="search-results"></div>
    `);
        }

        /**
         * Searches messages in the current channel
         */
        function searchMessages() {
            const query = document.getElementById('search-query').value.trim().toLowerCase();
            if (!query) return showNotification('Search term required');
            db.ref(`messages/${currentServer}/${currentChannel}`).once('value', snap => {
                const messages = snap.val() || {};
                const results = Object.entries(messages)
                    .filter(([_, msg]) => msg.text.toLowerCase().includes(query))
                    .map(([id, msg]) => `
                <div>
                    ${msg.username}: ${msg.text.replace(new RegExp(query, 'gi'), '<mark>$&</mark>')}
                    <button onclick="jumpToMessage('${id}')">Jump</button>
                </div>
            `);
                document.getElementById('search-results').innerHTML = results.length ? results.join('') : 'No results found';
            }).catch(err => showNotification('Search failed: ' + err.message));
        }

        /**
         * Jumps to a specific message in the chat
         * @param {string} id - Message ID
         */
        function jumpToMessage(id) {
            const message = document.querySelector(`.message[data-id="${id}"]`);
            if (message) {
                message.scrollIntoView({
                    behavior: 'smooth'
                });
                message.style.background = '#5865f230';
                setTimeout(() => message.style.background = '', 2000);
            }
            closeModal('search-modal');
        }

        // Pinned Messages
        /**
         * Opens the pinned messages modal
         */
        function openPinnedModal() {
            showModal('pinned-modal', `
        <h3>Pinned Messages</h3>
        <div id="pinned-messages"></div>
        <button class="cancel" onclick="closeModal('pinned-modal')">Close</button>
    `);
            db.ref(`servers/${currentServer}/pinned/${currentChannel}`).once('value', snap => {
                const pinned = snap.val() || {};
                const pinnedDiv = document.getElementById('pinned-messages');
                pinnedDiv.innerHTML = '';
                Promise.all(Object.keys(pinned).map(id =>
                    db.ref(`messages/${currentServer}/${currentChannel}/${id}`).once('value')
                    .then(msgSnap => {
                        const msg = msgSnap.val();
                        if (msg) {
                            return `<div>${msg.username}: ${msg.text} <button onclick="jumpToMessage('${id}')">Jump</button></div>`;
                        }
                        return '';
                    })
                )).then(results => {
                    pinnedDiv.innerHTML = results.filter(r => r).join('') || 'No pinned messages';
                }).catch(err => showNotification('Failed to load pinned messages: ' + err.message));
            });
        }

        // Friends Management
        /**
         * Opens the friends management modal
         */
        function openFriendsModal() {
            showModal('friends-modal', `
        <h3>Friends</h3>
        <input id="friend-username" placeholder="Username to add" title="Enter a username to add as a friend">
        <button onclick="addFriendByUsername()">Add Friend</button>
        <div id="friends-list"></div>
        <button class="cancel" onclick="closeModal('friends-modal')">Close</button>
    `);
            loadFriends();
        }

        /**
         * Loads the user's friends list
         */
        function loadFriends() {
            db.ref(`users/${currentUser.uid}/friends`).once('value', snap => {
                const friends = snap.val() || {};
                const friendsList = document.getElementById('friends-list');
                friendsList.innerHTML = '';
                Object.keys(friends).forEach(uid => {
                    db.ref(`users/${uid}`).once('value', userSnap => {
                        const friend = userSnap.val();
                        if (friend) {
                            friendsList.innerHTML += `
                        <div>
                            ${friend.username} (${friend.status === 'online' ? 'Online' : 'Offline'})
                            <button onclick="removeFriend('${uid}')">Remove</button>
                        </div>
                    `;
                        }
                    });
                });
            }).catch(err => showNotification('Failed to load friends: ' + err.message));
        }

        /**
         * Adds a friend by username
         */
        function addFriendByUsername() {
            const username = document.getElementById('friend-username').value.trim();
            if (!username) return showNotification('Username required');
            db.ref('users').orderByChild('username').equalTo(username).once('value', snap => {
                const users = snap.val();
                if (users) {
                    const uid = Object.keys(users)[0];
                    if (uid === currentUser.uid) return showNotification('You cannot add yourself');
                    db.ref(`users/${currentUser.uid}/friends/${uid}`).set(true)
                        .then(() => {
                            showNotification(`Added ${username} as a friend`);
                            loadFriends();
                        })
                        .catch(err => showNotification('Failed to add friend: ' + err.message));
                } else {
                    showNotification('User not found');
                }
            }).catch(err => showNotification('Search failed: ' + err.message));
        }

        /**
         * Adds a friend by UID
         * @param {string} uid - User ID
         */
        function addFriend(uid) {
            if (uid === currentUser.uid) return showNotification('You cannot add yourself');
            db.ref(`users/${currentUser.uid}/friends/${uid}`).set(true)
                .then(() => {
                    showNotification('Friend added');
                    closeContextMenu();
                    loadFriends();
                })
                .catch(err => showNotification('Failed to add friend: ' + err.message));
        }

        /**
         * Removes a friend
         * @param {string} uid - User ID
         */
        function removeFriend(uid) {
            db.ref(`users/${currentUser.uid}/friends/${uid}`).remove()
                .then(() => {
                    showNotification('Friend removed');
                    loadFriends();
                })
                .catch(err => showNotification('Failed to remove friend: ' + err.message));
        }

        // Typing Indicator
        /**
         * Updates the typing status for the current user
         */
        function updateTyping() {
            clearTimeout(typingTimeout);
            db.ref(`servers/${currentServer}/typing/${currentChannel}/${currentUser.uid}`).set({
                username: userData.username,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            typingTimeout = setTimeout(clearTyping, 3000);
        }

        /**
         * Clears the typing status
         */
        function clearTyping() {
            db.ref(`servers/${currentServer}/typing/${currentChannel}/${currentUser.uid}`).remove();
        }

        /**
         * Displays typing indicators
         */
        function displayTyping() {
            db.ref(`servers/${currentServer}/typing/${currentChannel}`).on('value', snap => {
                const typing = snap.val() || {};
                const users = Object.values(typing).filter(t => t.username !== userData.username).map(t => t.username);
                const indicator = document.createElement('div');
                indicator.className = 'message typing';
                indicator.innerHTML = `<div class="message-content">${users.length ? `${users.join(', ')} ${users.length > 1 ? 'are' : 'is'} typing...` : ''}</div>`;
                const messagesDiv = document.getElementById('messages');
                if (messagesDiv.lastChild?.className !== 'message typing') messagesDiv.appendChild(indicator);
                else if (users.length) messagesDiv.lastChild.outerHTML = indicator.outerHTML;
                else messagesDiv.lastChild?.remove();
            });
        }

        // Context Menu for Channels
        /**
         * Opens a context menu for a channel
         * @param {Event} e - Mouse event
         * @param {string} channel - Channel name
         */
        function openChannelContext(e, channel) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            menu.style.top = `${e.pageY}px`;
            menu.style.left = `${e.pageX}px`;
            menu.style.display = 'block';
            const isAdmin = serverData[currentServer]?.members[currentUser.uid]?.role === 'admin';
            menu.innerHTML = `
        <button onclick="deleteChannel('${channel}')" ${!isAdmin ? 'disabled' : ''}>Delete Channel</button>
        <button onclick="pinChannel('${channel}')">Pin Channel</button>
        <button onclick="openChannelModal()">New Channel</button>
        <button onclick="openInviteModal()">Invite Friends</button>
        <button onclick="closeContextMenu()">Close</button>
    `;
            document.addEventListener('click', closeContextMenu, {
                once: true
            });
        }

        /**
         * Deletes a channel
         * @param {string} channel - Channel name
         */
        function deleteChannel(channel) {
            if (confirm(`Delete #${channel}?`)) {
                db.ref(`servers/${currentServer}/channels/${channel}`).remove()
                    .then(() => {
                        if (currentChannel === channel) selectChannel('general');
                        showNotification(`Channel #${channel} deleted`);
                        logAudit(`Deleted channel ${channel} from server ${currentServer}`);
                    })
                    .catch(err => showNotification('Failed to delete channel: ' + err.message));
            }
            closeContextMenu();
        }

        /**
         * Pins a channel
         * @param {string} channel - Channel name
         */
        function pinChannel(channel) {
            db.ref(`servers/${currentServer}/channels/${channel}`).update({
                    pinned: true
                })
                .then(() => showNotification(`#${channel} pinned`))
                .catch(err => showNotification('Failed to pin channel: ' + err.message));
            closeContextMenu();
        }

        /**
         * Closes the context menu
         */
        function closeContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
        }

        // Audit Logging
        /**
         * Logs an audit event
         * @param {string} action - Action description
         */
        function logAudit(action) {
            db.ref(`servers/${currentServer}/audit`).push({
                user: currentUser.uid,
                username: userData.username,
                action,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            }).catch(err => console.error('Audit log failed: ' + err.message));
        }

        // Small Features
        /**
         * Toggles auto-scrolling of messages
         */
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            showNotification(`Auto-scroll ${autoScroll ? 'enabled' : 'disabled'}`);
        }

        /**
         * Clears the current channel's chat (admin only)
         */
        function clearChat() {
            const isAdmin = serverData[currentServer]?.members[currentUser.uid]?.role === 'admin';
            if (!isAdmin) return showNotification('Only admins can clear chat');
            if (confirm('Clear all messages in this channel?')) {
                db.ref(`messages/${currentServer}/${currentChannel}`).remove()
                    .then(() => {
                        showNotification('Chat cleared');
                        logAudit(`Cleared chat in channel ${currentChannel} of server ${currentServer}`);
                        loadMessages();
                    })
                    .catch(err => showNotification('Failed to clear chat: ' + err.message));
            }
        }

        /**
         * Refreshes the current chat
         */
        function refreshChat() {
            showLoading();
            loadMessages();
            showNotification('Chat refreshed');
        }

        /**
         * Shows server info in a modal
         */
        function showServerInfo() {
            const server = serverData[currentServer];
            showModal('server-info-modal', `
        <h3>Server Info</h3>
        <p><strong>Name:</strong> ${server.name}</p>
        <p><strong>Invite Code:</strong> ${server.inviteCode}</p>
        <p><strong>Members:</strong> ${Object.keys(server.members || {}).length}</p>
        <p><strong>Channels:</strong> ${Object.keys(server.channels || {}).length}</p>
        <p><strong>Created:</strong> ${formatTimestamp(server.createdAt)}</p>
        <button class="cancel" onclick="closeModal('server-info-modal')">Close</button>
    `);
        }

        // Keyboard Shortcuts
        /**
         * Handles keyboard shortcuts
         */
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && e.key === 'e') openEmojiPicker();
            if (e.ctrlKey && e.key === 'p') createPoll();
            if (e.ctrlKey && e.key === 'f') openSearchModal();
            if (e.ctrlKey && e.key === 'i') openInviteModal();
            if (e.ctrlKey && e.key === 'n') openChannelModal();
            if (e.ctrlKey && e.key === 'u') openProfile();
            if (e.ctrlKey && e.key === 's') openUserSettings();
            if (e.ctrlKey && e.key === 'm') openPinnedModal();
            if (e.ctrlKey && e.key === 'r') openFriendsModal();
            if (e.ctrlKey && e.key === 'c') clearChat();
            if (e.ctrlKey && e.key === 'l') refreshChat();
            if (e.ctrlKey && e.key === 'q') showServerInfo();
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
                closeContextMenu();
            }
        });

        // Initialization
        /**
         * Handles authentication state changes
         */
        auth.onAuthStateChanged(user => {
            if (user) {
                handleAuthSuccess(user);
            } else {
                currentUser = null;
                document.getElementById('app').style.display = 'none';
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('logout-btn').style.display = 'none';
            }
        });

        /**
         * Handles message input keypress
         */
        document.getElementById('message-input').addEventListener('keypress', e => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            } else {
                updateTyping();
            }
        });

        /**
         * Updates the UI based on current state
         */
        function updateUI() {
            if (!currentServer || !serverData[currentServer]) return;
            document.querySelector('.channels h3 span.title').textContent = serverData[currentServer].name;
            displayTyping();
            document.querySelector('.chat-header').innerHTML = `
        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
        </svg>
        <span id="channel-name">#${currentChannel}</span>
        <div class="tools">
            <button onclick="openSearchModal()" title="Search messages">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
            </button>
            <button onclick="openPinnedModal()" title="View pinned messages">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5l-1.41 1.41L12 8l-4-4L6.59 5.41 5 7V18a2 2 0 002 2h10a2 2 0 002-2V7l-1.59-1.59L15 5z" />
                </svg>
            </button>
            <button onclick="toggleAutoScroll()" title="Toggle auto-scroll">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                </svg>
            </button>
            <button onclick="clearChat()" title="Clear chat (admin only)">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5-4h4a1 1 0 011 1v1H9V4a1 1 0 011-1z" />
                </svg>
            </button>
            <button onclick="refreshChat()" title="Refresh chat">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
            </button>
            <button onclick="showServerInfo()" title="Show server info">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <button onclick="openProfile()" title="View and edit your profile">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </button>
            <button onclick="openUserSettings()" title="Edit server settings">
                <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
            </button>
        </div>
    `;
        }

        // Initial Load
        console.log('SuperChat initialized on', new Date().toLocaleString());
    </script>
</body>

</html>
